version: 2.1
jobs:
  build:
    docker:
      - image: circleci/python:3.7.3
    working_directory: ~/repo
    steps:
    - checkout
    - setup_remote_docker
    
    - restore_cache:
        key: v1-dependencies-{{ checksum "requirements.txt" }}

    - run:
        name: Install Dependencies
        command: |
          python -m venv venv
          . venv/bin/activate
          make install

    - run:
        name: Install Hadolint
        command: |
          sudo wget -O /bin/hadolint https://github.com/hadolint/hadolint/releases/download/v1.16.3/hadolint-Linux-x86_64 &&\
          sudo chmod +x /bin/hadolint
    
    - run:
        name: Install awscli
        command: sudo pip install awscli --upgrade
  
    - save_cache:
        paths:
          - venv/
        key: v1-dependencies-{{ checksum "requirements.txt" }}

    - run:
        name: Run Hadolint 
        command: |
          hadolint Dockerfile

    # - run:
    #     name: Run PyLint
    #     command: |
    #       . venv/bin/activate
    #       pylint routes.py

    - run:
        name: Build and Push Docker Image
        command: |
          docker build -t shubham-capstone .
          echo $DOCKERHUB_PASSWORD | docker login -u $DOCKERHUB_USERNAME --password-stdin
          docker tag shubham-capstone shubhammapara/shubham-capstone
          docker push shubhammapara/shubham-capstone

    - run:
        name: Deploy App to EKS
        command: |
          sh "aws eks --region ap-south-1 update-kubeconfig --name shubhamcapstone"
          sh "kubectl config use-context arn:aws:eks:ap-south-1:673823253587:cluster/shubhamcapstone"
          sh "kubectl apply -f k8s.yaml"
          sh "kubectl get nodes"
          sh "kubectl get deployments"
          sh "kubectl get pod -o wide"
          sh "kubectl get service/shubham-capstone"


workflows:
  build-and-lint:
    jobs:
      - build

