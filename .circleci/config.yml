version: 2.1
jobs:
  build:
    docker:
      - image: circleci/python:3.7.3
    working_directory: ~/repo
    steps:
    - checkout
    - setup_remote_docker
    
    # - restore_cache:
    #     keys: 
    #       - python_deps-{{ checksum "requirements.txt"}}

    - run:
        name: Install Dependencies
        command: |
          python -m venv venv
          . venv/bin/activate
          make install

    # - run:
    #     name: Install Hadolint
    #     command: |
    #       wget -O /bin/hadolint https://github.com/hadolint/hadolint/releases/download/v1.16.3/hadolint-Linux-x86_64 &&\
    #       chmod +x /bin/hadolint
  
    - save_cache:
        paths:
        - ./venv
        key: python_deps-{{ checksum "requirements.txt"}}

    # - run:
    #     name: Run Hadolint 
    #     command: |
    #       hadolint Dockerfile

    # - run:
    #     name: Run PyLint
    #     command: |
    #       . venv/bin/activate
    #       pylint routes.py

    - run:
        name: Build and Push Docker Image
        command: |
          docker build -t shubham-capstone .
          echo $DOCKERHUB_PASSWORD | docker login -u $DOCKERHUB_USERNAME --password-stdin
          docker tag shubham-capstone shubhammapara/shubham-capstone
          docker push shubhammapara/shubham-capstone

    # - run:
    #     name: Deploy App to EKS
    #     command: |


workflows:
  build-and-lint:
    jobs:
      - build

